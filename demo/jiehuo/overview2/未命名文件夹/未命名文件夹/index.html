<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">


    <link rel="icon" href="./res/favicon.ico" type="image/x-icon" />

    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <meta name="keywords" content="">
    <meta name="description" content="">

    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /> -->



    <!-- <script src="./vconsole.min.js"></script>
    <script>
        var vConsole = new VConsole();
    </script> -->



    <style>
        body {
            margin: 0
        }

        #whole-loading {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            background: #1d1b22;
        }

        #whole-loading .loading-content {
            /* width: 50%;
            height: 50%; */
            text-align: center;
            display: flex;
            align-items: center;
            flex-direction: column;
        }

        #whole-loading .loading-content .loading-img {
            width: 100px;
            height: 100px;
        }

        #whole-loading .loading-content .loading-text {
            color: #e7981f;
            margin-top: 10px;
            font-size: 45px;
            font-weight: bold;
        }
    </style>
</head>







<title>Wonder</title>
</head>

<body>
    <script src="../../test/e2e/js/AssetTool.js"></script>
    <script src="../../test/e2e/js/BasicBoxesTool.js"></script>
    <script src="../../test/e2e/js/LightBoxesTool.js"></script>
    <script src="../../test/e2e/js/PositionTool.js"></script>
    <script src="../../test/e2e/js/LightTool.js"></script>
    <script src="../../test/e2e/js/CameraTool.js"></script>
    <script src="../../test/e2e/js/LightMaterialTool.js"></script>
    <script src="../../dist/wd.js"></script>

    <div id="whole-loading">
        <div class="loading-content">
            <div>
                <img id="logo" class="loading-img" src="./res/logo.png" />
            </div>
            <div>
                <div id="text" class="loading-text">加载中...</div>
            </div>
        </div>
    </div>

    <canvas id="ui-canvas" style="
    position:absolute;
    left:0;
    top:0;
    z-index:100;
    "></canvas>




    <textarea id="mark_text" style="
    position:absolute;
    left:150px;
    top:0px;
    z-index:101;
    ">加入描述信息</textarea>



    <button id="mark_begin_button" style="
    width:50px;height:50px;
    position:absolute;
    left:150px;
    top:100px;
    z-index:101;
    ">开始标记</button>


    <button id="mark_end_button" style="
    width:50px;height:50px;
    position:absolute;
    left:200px;
    top:100px;
    z-index:101;
    ">结束标记</button>



    <button id="clear_draw_mark" style="
    width:50px;height:50px;
    position:absolute;
    left:250px;
    top:100px;
    z-index:101;
    ">清空标记</button>



    <script>

        var currentSkybox = 0;




        function _createMarkData() {
            return {
                isBeginMark: false,
                totalMarkPosInWorld: []
            }
        }


        // TODO add more skybox data


        var skybox1Data = {
            markData: _createMarkData(),
            skyboxData:
                [
                    [
                        "./res/skybox1/7计算机楼内right.jpg", "skybox1_px",
                    ],
                    [
                        "./res/skybox1/7计算机楼内left.jpg", "skybox1_nx",
                    ],
                    [
                        "./res/skybox1/7计算机楼内top.jpg", "skybox1_py",
                    ],
                    [
                        "./res/skybox1/7计算机楼内bottom.jpg", "skybox1_ny",
                    ],
                    [
                        "./res/skybox1/7计算机楼内front.jpg", "skybox1_pz",
                    ],
                    [
                        "./res/skybox1/7计算机楼内back.jpg", "skybox1_nz",
                    ]
                ],
            jumpData: [{
                /*
                line 925: console.log the posInWorld when mousedown

                so you can get the posInWorld by mousedown!
                */
                posInWorld:
                    [2.5570664216941297, -1.0112567313798855, 5],
                text: "通往大门",
                //jump to skybox2
                skyboxIndex: 1
            }]
        };


        var skybox2Data = {
            markData: _createMarkData(),
            skyboxData: [
                [
                    "./res/skybox2/px.jpg", "skybox2_px",
                ],
                [
                    "./res/skybox2/nx.jpg", "skybox2_nx",
                ],
                [
                    "./res/skybox2/py.jpg", "skybox2_py",
                ],
                [
                    "./res/skybox2/ny.jpg", "skybox2_ny",
                ],
                [
                    "./res/skybox2/pz.jpg", "skybox2_pz",
                ],
                [
                    "./res/skybox2/nz.jpg", "skybox2_nz",
                ]
            ],
            jumpData: [{
                posInWorld:
                    [2.5570664216941297, -1.0112567313798855, 5],
                text: "通往校园",
                //jump to skybox1
                skyboxIndex: 0
            }]
        };



        function _getAllSkyboxData() {
            return [skybox1Data, skybox2Data];
        }



        function _getCurrentSkyboxData() {
            switch (currentSkybox) {
                case 0:
                    return skybox1Data;
                case 1:
                    return skybox2Data;
            }
        }

        function _setCurrentSkyboxIndex(index) {
            currentSkybox = index;
        };


        function showWholeLoading() {
            // document.querySelector("#stream-loading").style.display = "none";
            document.querySelector("#whole-loading").style.display = "flex";
        }

        function removeLoadingInfo() {
            // document.querySelector("#stream-loading").remove();
            document.querySelector("#whole-loading").remove();
        }




        window.onload = function () {
            showWholeLoading();


            return AssetTool.loadConfig(["./config/setting.json", "./config/"], null, function () {
                try {

                    AssetTool.loadIMGUIAsset("./res/font/Lato-Regular-64.fnt", "./res/font/lato.png",
                        [
                            ["./res/jump/flag.png", "jump"]
                        ],
                        function (state) {

                            wd.loadImageDataArr(
                                _getAllSkyboxData().reduce((result, { skyboxData }) => {
                                    return result.concat(skyboxData)
                                }, [])
                            ).then((resultMap) => {
                                removeLoadingInfo();

                                return initSample(
                                    _getAllSkyboxData().reduce((result, { skyboxData }) => {
                                        result.push(
                                            skyboxData.map(([_, id]) => {
                                                return resultMap[id]
                                            })
                                        );

                                        return result;
                                    }, []),


                                    state
                                );
                            })
                        },
                        wd.unsafeGetState()
                    );






                    // initSample(wd.unsafeGetState())





                }
                catch (e) {
                    console.log("error: ", e)
                }
            });




            function _preventDefault(customEvent) {
                var event = wd.getPointEventEventOfEvent(wd.getCustomEventUserData(customEvent));

                if (event.cancelable) {
                    if (!event.defaultPrevented) {
                        event.preventDefault();
                    }
                }
            }


            function _getInterctedPoint(event, cameraGameObject, state, box2) {
                var ray = wd.createPerspectiveCameraRayFromEvent(
                    event,
                    cameraGameObject, state
                );

                var checkResult =
                    wd.checkIntersectMesh(
                        ray,
                        wd.unsafeGetGameObjectGeometryComponent(
                            box2, state,

                        ),
                        wd.getTransformLocalToWorldMatrixTypeArray(
                            wd.unsafeGetGameObjectTransformComponent(
                                box2, state
                            ), state
                        ),
                        1,
                        state
                    );

                var point =
                    wd.getIntersectedPointWithMesh(
                        checkResult
                    );

                // console.log(point);

                return point;

            };

            function _getScreenSize() {
                return [window.innerWidth, window.innerHeight];
            };


            function _isPointInScreenValid(pointInScreen) {
                return pointInScreen !== undefined;
            }

            function _isPointInScreenDataValid([pointInScreen, _lineType, _lineAlpha]) {
                return _isPointInScreenValid(pointInScreen);
            }


            function _bindArcballCameraControllerEvent(cameraController, state) {
                if (wd.isBindArcballCameraControllerEvent(
                    cameraController, state
                )) {
                    return state;
                }

                var state = wd.bindArcballCameraControllerEvent(
                    cameraController, state
                );

                var state = wd.unbindArcballCameraControllerPointScaleEvent(cameraController, state);

                return state
            }





            function _drawMark(uiContext, markData, cameraGameObject, state) {
                markData.totalMarkPosInWorld.forEach(([markPosInWorld, text]) => {
                    var [screenWidth, screenHeight] = _getScreenSize();

                    var pointInScreen =
                        wd.convertWorldToScreen(
                            wd.unsafeGetGameObjectBasicCameraViewComponent(
                                cameraGameObject, state
                            ),
                            wd.unsafeGetGameObjectPerspectiveCameraProjectionComponent(
                                cameraGameObject, state
                            ),
                            [
                                markPosInWorld[0],
                                markPosInWorld[1],
                                markPosInWorld[2],
                                screenWidth, screenHeight
                            ],
                            state
                        );

                    if (!_isPointInScreenValid(pointInScreen)) {
                        return;
                    }



                    uiContext.textAlign = "center";
                    uiContext.textBaseline = "middle";

                    uiContext.fillStyle = "blue";

                    uiContext.fillText(text, pointInScreen[0], pointInScreen[1]);
                });


                return markData;
            }


            function _drawJumpText(uiContext, jumpData, cameraGameObject, state) {
                jumpData.forEach(({
                    posInWorld,
                    text
                }) => {
                    var [screenWidth, screenHeight] = _getScreenSize();

                    var pointInScreen =
                        wd.convertWorldToScreen(
                            wd.unsafeGetGameObjectBasicCameraViewComponent(
                                cameraGameObject, state
                            ),
                            wd.unsafeGetGameObjectPerspectiveCameraProjectionComponent(
                                cameraGameObject, state
                            ),
                            [
                                posInWorld[0],
                                posInWorld[1],
                                posInWorld[2],
                                screenWidth, screenHeight
                            ],
                            state
                        );

                    if (!_isPointInScreenValid(pointInScreen)) {
                        return;
                    }



                    uiContext.textAlign = "center";
                    uiContext.textBaseline = "middle";

                    uiContext.fillStyle = "red";

                    uiContext.fillText(text, pointInScreen[0], pointInScreen[1] + 20);
                });


                return jumpData;
            }


            function _isTargetDom(event, domId) {
                return event.target.id === domId
            }


            function _isPickJump(
                [x, y],
                jumpData,
                cameraGameObject,
                state) {
                var [screenWidth, screenHeight] = _getScreenSize();

                return jumpData.reduce((result,
                    {
                        posInWorld,
                        text,
                        skyboxIndex
                    }
                ) => {
                    var [isPick, _] = result;

                    if (isPick) {
                        return result;
                    }



                    var pointInScreen =
                        wd.convertWorldToScreen(
                            wd.unsafeGetGameObjectBasicCameraViewComponent(
                                cameraGameObject, state
                            ),
                            wd.unsafeGetGameObjectPerspectiveCameraProjectionComponent(
                                cameraGameObject, state
                            ),
                            [
                                posInWorld[0],
                                posInWorld[1],
                                posInWorld[2],
                                screenWidth, screenHeight
                            ],
                            state
                        );

                    if (!_isPointInScreenValid(pointInScreen)) {
                        return result;
                    }


                    if (
                        Math.abs(pointInScreen[0] - x) <= 20
                        &&
                        Math.abs(pointInScreen[1] - y) <= 80
                    ) {
                        return [true, skyboxIndex];
                    }

                    return result;
                }, [false, -1]);
            }


            function initSample(
                skyboxImageDataArr,
                state
            ) {
                console.log("begin");



                var state = wd.setSetting(
                    {
                        "textColor": [1.0, 1.0, 1.0],
                        "buttonSetting": {
                            "buttonColor": [0.5, 0.5, 0.5],
                            "hoverButtonColor": [0.5, 0.0, 1.0],
                            "clickButtonColor": [0.5, 1.0, 0.0]
                        },
                        "radioButtonSetting": {

                            "radioButtonOuterColor": [0.3, 0.3, 0.3],
                            "radioButtonInnerColor":



                                [0.15, 0.15, 0.15],


                            "radioButtonOuterColorHover":
                                [0.33, 0.33, 0.33],


                            "radioButtonInnerColorHover":

                                [0.15, 0.15, 0.15],

                            "radioButtonCircleSegments":

                                9,

                            "radioButtonInnerRadius": 0.6,

                            "radioButtonOuterRadius":
                                1.0
                        },
                        "checkboxSetting": {

                            "checkboxOuterColor": [0.3, 0.3, 0.3],
                            "checkboxInnerColor":



                                [0.15, 0.15, 0.15],


                            "checkboxOuterColorHover":
                                [0.33, 0.33, 0.33],


                            "checkboxInnerColorHover":

                                [0.15, 0.15, 0.15],


                            "checkboxInnerSizeRatio": 0.6,

                            "checkboxOuterSizeRatio":
                                1.0
                        },
                        "sliderSetting": {

                            "sliderBackgroundColor": [0.3, 0.3, 0.3],
                            "sliderFillColor":



                                [0.15, 0.15, 0.15],


                            "sliderBackgroundColorHover":
                                [0.33, 0.33, 0.33],


                            "sliderFillColorHover":

                                [0.15, 0.15, 0.15],
                        },
                        "fontTexUvForWhite": [0.045, 0.012]
                    }, state
                );



                var state = wd.setIMGUIFunc(
                    1, (customData, api, state) => {
                        var jumpData = _getCurrentSkyboxData().jumpData;


                        var [screenWidth, screenHeight] = _getScreenSize();

                        var state = jumpData.reduce((state, {
                            posInWorld,
                            text
                        }) => {

                            var pointInScreen =
                                wd.convertWorldToScreen(
                                    wd.unsafeGetGameObjectBasicCameraViewComponent(
                                        cameraGameObject, state
                                    ),
                                    wd.unsafeGetGameObjectPerspectiveCameraProjectionComponent(
                                        cameraGameObject, state
                                    ),
                                    [
                                        posInWorld[0],
                                        posInWorld[1],
                                        posInWorld[2],
                                        screenWidth, screenHeight
                                    ],
                                    state
                                );

                            if (!_isPointInScreenValid(pointInScreen)) {
                                return state;
                            }


                            var state = api.image(
                                [pointInScreen[0] - 50, pointInScreen[1] - 100, 100, 100], [0, 0, 1, 1], "jump", state
                            );



                            return state;
                        }, state);



                        return state;
                    }, state);







                var state = _switchSkybox(
                    0,
                    skyboxImageDataArr,
                    // [
                    //     px, nx, py, ny, pz, nz
                    // ],
                    state);


                var uiCanvas = document.querySelector("#ui-canvas");

                uiCanvas.width = window.innerWidth;
                uiCanvas.height = window.innerHeight;

                uiCanvas.style.width = "100%";
                uiCanvas.style.height = "100%";


                var uiContext = uiCanvas.getContext("2d");









                // var [state, box1] = LightBoxesTool.createBox(state);



                // var transform = wd.unsafeGetGameObjectTransformComponent(box1, state);

                // var state = wd.setTransformLocalPosition(transform, [0, 0, -30], state);



                var [state, box2] = BasicBoxesTool.createBox(state);




                var transform = wd.unsafeGetGameObjectTransformComponent(box2, state);

                var state = wd.setTransformLocalPosition(transform, [0, 0, 0], state);







                // var [state, box3] = LightBoxesTool.createBox(state);



                // var transform = wd.unsafeGetGameObjectTransformComponent(box3, state);

                // var state = wd.setTransformLocalScale(transform, [0.2, 0.2, 0.2], state);














                var state = wd.setAmbientLightColor([0.2, 0.2, 0.2], state);


                var [state, directionLightGameObject] = LightTool.createDirectionLight(state);

                var transform = wd.unsafeGetGameObjectTransformComponent(directionLightGameObject, state);

                var state = wd.setTransformLocalEulerAngles(transform, [0, 180, 0], state);




                var [state, cameraGameObject] = LightBoxesTool.createCamera(state);



                var [state, cameraController] = wd.createArcballCameraController(state);

                var state =
                    wd.setArcballCameraControllerMinDistance(cameraController, 0.001, state);
                var state =
                    wd.setArcballCameraControllerDistance(cameraController, 0.001, state);



                var state =
                    wd.setArcballCameraControllerWheelSpeed(cameraController, 1, state);

                var state = wd.addGameObjectArcballCameraControllerComponent(cameraGameObject, cameraController, state);


                var state = _bindArcballCameraControllerEvent(cameraController, state);









                document.querySelector("#mark_text").addEventListener("mousedown", function () {
                    console.log("unbind")
                    wd.setState(wd.unbindArcballCameraControllerEvent(cameraController, wd.unsafeGetState()));
                }, true);


                document.querySelector("#mark_text").addEventListener("blur", function () {
                    wd.setState(_bindArcballCameraControllerEvent(cameraController, wd.unsafeGetState()));
                }, true);



                document.querySelector("#mark_begin_button").addEventListener("mousedown", function () {
                    var state = wd.unsafeGetState();

                    var state =
                        wd.unbindArcballCameraControllerEvent(
                            cameraController, state
                        );

                    wd.setState(state);
                }, true)


                document.querySelector("#mark_begin_button").addEventListener("mouseup", function () {
                    var markData = _getCurrentSkyboxData().markData;

                    markData.isBeginMark = true;
                }, true)



                document.querySelector("#mark_end_button").addEventListener("mousedown", function () {
                    var markData = _getCurrentSkyboxData().markData;

                    markData.isBeginMark = false;

                    var state = wd.unsafeGetState();

                    var state =
                        _bindArcballCameraControllerEvent(
                            cameraController, state
                        );

                    wd.setState(state);
                }, true)



                document.querySelector("#clear_draw_mark").addEventListener("mousedown", function () {
                    _getCurrentSkyboxData().markData = {
                        isBeginMark: false,
                        totalMarkPosInWorld: []
                    }
                }, true)


                function _switchSkybox(index, skyboxImageDataArr, state) {
                    currentSkybox = index;

                    _setCurrentSkyboxIndex(index);

                    var state = wd.setSkyboxImage(
                        skyboxImageDataArr[index], state
                    );

                    var state = wd.setSkyboxNeedUpdateCubeTexture(true, state);

                    return state;
                }


                var isPickRef = false
                var skyboxIndexRef = -1;


                var state =
                    wd.onCustomGlobalEvent(
                        wd.getPointDownEventName(),
                        0,
                        (event, state) => {
                            var [isPick, skyboxIndex] =
                                _isPickJump(
                                    wd.getPointEventLocationInViewOfEvent(wd.getCustomEventUserData(event)),
                                    _getCurrentSkyboxData().jumpData,
                                    cameraGameObject,
                                    state
                                );

                            if (isPick) {
                                isPickRef = isPick;
                                skyboxIndexRef = skyboxIndex;
                            }
                            else {
                                isPickRef = false;
                                skyboxIndexRef = skyboxIndex;
                            }

                            return [state, event];

                        }, state
                    );

                var state =
                    wd.onCustomGlobalEvent(
                        wd.getPointTapEventName(),
                        0,
                        (event, state) => {
                            if (isPickRef) {
                                var state = _switchSkybox(skyboxIndexRef, skyboxImageDataArr, state);

                                return [state, event];
                            }

                            return [state, event];

                        }, state
                    );


                var state =
                    wd.onCustomGlobalEvent(
                        wd.getPointDownEventName(),
                        0,
                        (event, state) => {
                            console.log("posInWorld: ",
                                _getInterctedPoint(event, cameraGameObject, state, box2),
                            );

                            var markData = _getCurrentSkyboxData().markData;

                            var {
                                isBeginMark
                            } = markData;


                            if (
                                !isBeginMark
                                || _isTargetDom(
                                    wd.getPointEventEventOfEvent(
                                        wd.getCustomEventUserData(event)
                                    ),
                                    "mark_end_button"
                                )
                            ) {
                                return [state, event];
                            }

                            markData.totalMarkPosInWorld.push([
                                _getInterctedPoint(event, cameraGameObject, state, box2),
                                document.querySelector("#mark_text").value
                            ]);

                            return [state, event];

                        }, state
                    );






                var state = wd.registerNoWorkerLoopJob("update_ui", (_, state) => {
                    uiContext.clearRect(0, 0, uiCanvas.width, uiCanvas.height);

                    var markData = _getCurrentSkyboxData().markData;

                    _getCurrentSkyboxData().markData = _drawMark(
                        uiContext,
                        markData, cameraGameObject, state
                    );


                    var jumpData = _getCurrentSkyboxData().jumpData;

                    _getCurrentSkyboxData().jumpData = _drawJumpText(
                        uiContext,
                        jumpData, cameraGameObject, state
                    );


                    return state;
                }, state);








                wd.startDirector(state);


                console.log("end");
            }
        };
    </script>
</body>

</html>