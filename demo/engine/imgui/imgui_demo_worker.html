<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">

    <link rel="icon" href="../asset/logo/favicon.ico" type="image/x-icon" />

    <title>imgui</title>
</head>

<body>
    <script src="../js/AssetTool.js"></script>
    <script src="../js/ReplaceFetchTool.js"></script>
    <script src="../js/ScheduleTool.js"></script>
    <script src="../js/BasicBoxesTool.js"></script>
    <script src="../js/LightBoxesTool.js"></script>
    <script src="../js/PositionTool.js"></script>
    <script src="../js/LightTool.js"></script>
    <script src="../js/CameraTool.js"></script>
    <script src="../js/GeometryTool.js"></script>
    <script src="../js/BasicMaterialTool.js"></script>
    <script src="../js/LightMaterialTool.js"></script>
    <script src="../js/IMGUITool.js"></script>


    <script src="../js/demo/IMGUITool.js"></script>
    <script src="../js/demo/WorkerTool.js"></script>

    <script src="../../../engine/dist/wd.js"></script>


    <h1 id="detect" style="display: none">your browser not support sharedArrayBuffer or offscreenCanvas</h1>

    <div id="loading">
        <img id="logo" style="display: none;" src="../asset/logo/logo.png" width=100 height=100 />
        <br />
        <span id="text"></span>
    </div>



    <script>


        function createControls(api, truckGameObject, boxGameObject, screenWidth, screenHeight, buildImguiFunc, getIMGUIRegion, getOrCreateCustomData, state) {
            function syncCustomDataBetweenMainWorkerAndRenderWorker(api, state) {
                var customData = api.getCustomDataFromMainWorkerToRenderWorker(state);

                // console.log("sync: ", customData);


                var state = api.setCustomDataFromRenderWorkerToMainWorker({
                    fps: customData.fps
                }, state);

                return state;
            }

            function toggleShowPanelData(customData, state) {
                var isShowPanel = false;

                if (customData.isShowPanel === true) {
                    isShowPanel = false;
                }
                else {
                    isShowPanel = true;
                }



                return isShowPanel;
            }



            var radioButtonWidth = 300;
            var radioButtonHeight = 100;

            var x = 50;

            var intervalX = 400;

            var state = syncCustomDataBetweenMainWorkerAndRenderWorker(api, state);

            var boxColorArr = [0.0, 0.5, 0.5];


            var customData = api.getCustomDataFromRenderWorkerToMainWorker(state);


            var customDataInRenderWorker = api.getCustomDataInRenderWorker(state);

            customDataInRenderWorker = getOrCreateCustomData(customDataInRenderWorker);


            var buttonText = null;

            if (customDataInRenderWorker.isShowPanel === true) {
                buttonText = "hide panel";
            }
            else {
                buttonText = "show panel";
            }


            var [state, isClick_button1] = api.button(
                // [100, 800, 350, 100], "show panel", state
                [100, 0, 350, 100], buttonText, state
            );

            if (isClick_button1) {
                var customData = api.getCustomDataFromRenderWorkerToMainWorker(state);

                var isShowPanel = toggleShowPanelData(customDataInRenderWorker, state);


                console.log("toggle isShowPanel:", isShowPanel, customData);

                customDataInRenderWorker.isShowPanel = isShowPanel;
                customData.isShowPanel = isShowPanel;

                var state = api.setCustomDataInRenderWorker(customDataInRenderWorker, state);
                var state = api.setCustomDataFromRenderWorkerToMainWorker(customData, state);

                return state
            }


            // var customData = api.getCustomDataFromRenderWorkerToMainWorker(state);

            if (customDataInRenderWorker.isShowPanel === undefined || customDataInRenderWorker.isShowPanel === false) {
                return state;
            }


            var customData = api.getCustomDataFromRenderWorkerToMainWorker(state);


            var [state, selectIndex_radioButton, selectIndex_checkbox1, value_shininess] = buildImguiFunc(api, customData.fps, screenWidth, screenHeight, getIMGUIRegion, state);



            customData.selectIndex_radioButton = selectIndex_radioButton;
            customData.selectIndex_checkbox1 = selectIndex_checkbox1;
            customData.value_shininess = value_shininess;

            var state = api.setCustomDataFromRenderWorkerToMainWorker(customData, state);



            return state

        }


        function hasRenderWorkerCustomData(customData) {
            return !!customData && Object.prototype.toString.call(customData) === "[object Object]";
        }

        function setIMGUI(state, truckGameObject, boxGameObject) {
            var state = ImguiTool.setSetting([0.045, 0.012], state);




            var state = wd.setIMGUIFunc(
                [

                    createControls,
                    DemoImguiTool.buildImguiFunc,
                    DemoImguiTool.getIMGUIRegion,
                    DemoWorkerTool.getOrCreateCustomData,
                    truckGameObject,
                    boxGameObject,
                    window.innerWidth,
                    window.innerHeight
                ],
                (customData, api, state) => {
                    var [
                        createControls,
                        buildImguiFunc,
                        getIMGUIRegion,
                        getOrCreateCustomData,
                        truckGameObject,
                        boxGameObject,
                        screenWidth,
                        screenHeight
                    ] = customData;

                    var state = createControls(api, truckGameObject, boxGameObject, screenWidth, screenHeight, buildImguiFunc, getIMGUIRegion, getOrCreateCustomData, state);



                    return state

                }, state);









            return state;
        }


        // function _createLightsAndCamera(state) {
        //     var state = LightTool.setAmbientLight(state);



        //     var record = LightTool.createDirectionLight(state);
        //     var state = record[0];
        //     var directionLightObj = record[1];



        //     var transform = wd.unsafeGetGameObjectTransformComponent(directionLightObj, state);

        //     state = wd.setTransformLocalPosition(transform, [-10, 0, 20], state);



        //     var light = wd.unsafeGetGameObjectDirectionLightComponent(directionLightObj, state);

        //     var state = wd.setDirectionLightColor(light, [1.0, 1.0, 1.0], state);




        //     var data = LightBoxesTool.createCamera(state);
        //     var state = data[0];
        //     var camera = data[1];


        //     var transform = wd.unsafeGetGameObjectTransformComponent(camera, state);

        //     var [state, cameraController] = wd.createArcballCameraController(state);

        //     var state =
        //         wd.setArcballCameraControllerDistance(cameraController, 10, state);



        //     var state =
        //         wd.setArcballCameraControllerWheelSpeed(cameraController, 5, state);

        //     var state = wd.addGameObjectArcballCameraControllerComponent(camera, cameraController, state);


        //     var state =
        //         wd.bindArcballCameraControllerEvent(
        //             cameraController, state
        //         );


        //     return [state, directionLightObj]
        // }

        function bindEvent(state) {
            return DemoImguiTool.bindEvent((state) => {
                var customData = wd.getRenderWorkerCustomData(state);

                return customData.isShowPanel;
            }, state);
        };


        function initSample(state, truckGameObject, boxGameObject) {
            var state = bindEvent(state);

            var truckTransform = wd.unsafeGetGameObjectTransformComponent(truckGameObject, state);
            var boxTransform = wd.unsafeGetGameObjectTransformComponent(boxGameObject, state);

            var state = wd.setTransformLocalPosition(truckTransform, [0, 0, 0], state);
            var state = wd.setTransformLocalPosition(boxTransform, [-1000, -1000, -1000], state);





            var state =
                ScheduleTool.scheduleWorkerMainLoopUnSafeJob((stateData) => {
                    var state = wd.unsafeGetState();

                    var customData = wd.getRenderWorkerCustomData(state);

                    // console.log("render worker to main worker customData:", customData);


                    state =
                        wd.setMainWorkerCustomData(
                            {
                                fps: wd.getFps(state)
                            }, state
                        );


                    // var targetGameObject = null;
                    var targetGameObjectArr = null;

                    var truckTransform = wd.unsafeGetGameObjectTransformComponent(truckGameObject, state);
                    var boxTransform = wd.unsafeGetGameObjectTransformComponent(boxGameObject, state);


                    switch (customData.selectIndex_radioButton) {
                        case 0:
                            var children =
                                AssetTool.getAllChildren(
                                    truckGameObject, state
                                );



                            targetGameObjectArr =
                                children.filter((child) => {
                                    return wd.hasGameObjectLightMaterialComponent(child, state)
                                });


                            state = wd.setTransformLocalPosition(truckTransform, [0, 0, 0], state);
                            state = wd.setTransformLocalPosition(boxTransform, [[-1000, -1000, -1000]], state);
                            break;

                        case 1:
                            targetGameObjectArr = [
                                wd.unsafeGetTransformGameObject(
                                    wd.unsafeGetTransformChildren(
                                        boxTransform, state
                                    )[0], state
                                )
                            ];


                            state = wd.setTransformLocalPosition(boxTransform, [0, 0, 0], state);
                            state = wd.setTransformLocalPosition(truckTransform, [-1000, -1000, -1000], state);
                            break;
                        default:
                            var children =
                                AssetTool.getAllChildren(
                                    truckGameObject, state
                                );



                            targetGameObjectArr =
                                children.filter((child) => {
                                    return wd.hasGameObjectLightMaterialComponent(child, state)
                                });

                            break;
                    };



                    var lightMaterialArr =
                        targetGameObjectArr.map((targetGameObject) => {
                            return wd.unsafeGetGameObjectLightMaterialComponent(targetGameObject, state)
                        });

                    switch (customData.selectIndex_checkbox1) {
                        case true:
                            state =
                                lightMaterialArr.reduce((state, lightMaterial) => {
                                    return wd.setLightMaterialSpecularColor(lightMaterial, [1, 1, 1], state);
                                }, state);

                            break;
                        case false:
                            state =
                                lightMaterialArr.reduce((state, lightMaterial) => {
                                    return wd.setLightMaterialSpecularColor(lightMaterial, [0, 0, 0], state);
                                }, state);

                            break;
                        default:
                            break
                    };






                    if (customData.value_shininess !== undefined) {
                        state =
                            lightMaterialArr.reduce((state, lightMaterial) => {
                                return wd.setLightMaterialShininess(lightMaterial, customData.value_shininess, state);
                            }, state);

                    }









                    wd.setState(state)

                }, state);





            var state = setIMGUI(state, truckGameObject, boxGameObject);





            // var [state, directionLightObj] = _createLightsAndCamera(state);
            var state = AssetTool.createLightsAndCamera(state);

            // return wd.startDirector(state);
            return state;
        }


        window.onload = function () {
            if (wd.isSupportRenderWorkerAndSharedArrayBuffer() === false) {
                document.querySelector("#detect").style.display = "block";

                return;
            }
            else {
                document.querySelector("#detect").style.display = "none";
            }


            var loadedIMGUIByteLength = 0;

            var totalIMGUIByteLength = (76 + 258 + 26) * 1024;
            var totalWDBByteLength = 550 * 1024;
            var totalByteLength = totalIMGUIByteLength + totalWDBByteLength;




            return AssetTool.loadConfig(["../../../engine/config/setting_worker.json", "../../../engine/config/"], null, function () {
                return AssetTool.loadIMGUIAsset("../asset/font/Lato-Regular-64.fnt", "../asset/font/lato.png",
                    [
                        ["../asset/image/1.jpg", "1"],
                        ["../asset/image/2.png", "2"],
                    ],

                    function (contentLength, filePath) {
                        loadedIMGUIByteLength += contentLength;

                        AssetTool.showOrCreateLoadingInfo(
                            loadedIMGUIByteLength,
                            totalByteLength
                        );
                    },
                    function (state) {
                        return AssetTool.loadStreamWDB("../asset/wdb/imgui.wdb",
                            function (totalLoadedByteLength, contentLength, wdbPath) {
                                AssetTool.showOrCreateLoadingInfo(
                                    loadedIMGUIByteLength + totalLoadedByteLength,
                                    totalByteLength
                                );
                            },
                            function (state, gameObject) {
                                var children = AssetTool.getChildren(gameObject, state);

                                var boxGameObject = children[0];
                                var truckGameObject = children[1];


                                return initSample(state, truckGameObject, boxGameObject);
                            },
                            function (state, gameObject) {
                                AssetTool.removeLoadingInfo();

                                return state;
                            },
                            function (state, _, gameObject) {
                                AssetTool.removeLoadingInfo();

                                var children = AssetTool.getChildren(gameObject, state);

                                var boxGameObject = children[0];
                                var truckGameObject = children[1];


                                var state = initSample(state, truckGameObject, boxGameObject);

                                wd.startDirector(state);
                            }, state);
                    }, wd.unsafeGetState());
            });
        };
    </script>
</body>

</html>