<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">


    <link rel="icon" href="./res/favicon.ico" type="image/x-icon" />

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <meta name="keywords" content="">
    <meta name="description" content="">

    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />



    <script src="./vconsole.min.js"></script>
    <script>
        var vConsole = new VConsole();
    </script>



    <title>Wonder</title>
</head>

<body>
    <script src="../../test/e2e/js/AssetTool.js"></script>
    <script src="../../test/e2e/js/BasicBoxesTool.js"></script>
    <script src="../../test/e2e/js/LightBoxesTool.js"></script>
    <script src="../../test/e2e/js/PositionTool.js"></script>
    <script src="../../test/e2e/js/LightTool.js"></script>
    <script src="../../test/e2e/js/CameraTool.js"></script>
    <script src="../../test/e2e/js/LightMaterialTool.js"></script>
    <script src="../../dist/wd.js"></script>



    <canvas id="ui-canvas" style="
    position:absolute;
    left:0;
    top:0;
    z-index:100;
    "></canvas>

    <button id="begin_draw_line" style="width:50px;height:50px;
    position:absolute;
    left:0px;
    top:0px;
    z-index:101;
    ">开始画线</button>


    <select id="line_type" style="width:50px;height:50px;
    position:absolute;
    left:0px;
    top:100px;
    z-index:101;
    ">
        <option value="solid">实线</option>
        <option value="dash">虚线</option>
    </select>

    <!-- <button id="begin_draw_dash_line" style="width:100px;height:100px;
    position:absolute;
    left:0px;
    top:200px;
    z-index:101;
    ">开始虚线</button> -->


    <button id="end_draw_line" style="width:50px;height:50px;
    position:absolute;
    left:100px;
    top:0px;
    z-index:101;
    ">结束画线</button>


    <button id="clear_draw_line" style="
    width:50px;height:50px;
    position:absolute;
    left:100px;
    top:100px;
    z-index:101;
    ">清空线</button>



    <input type="range" id="line_alpha" name="line_alpha" value="1" min="0" max="1" step="0.05" style="
    position:absolute;
    left:200px;
    top:50px;
    z-index:101;
    ">


    <textarea id="mark_text" style="
    position:absolute;
    left:150px;
    top:0px;
    z-index:101;
    ">加入描述信息</textarea>



    <button id="mark_begin_button" style="
    width:50px;height:50px;
    position:absolute;
    left:150px;
    top:100px;
    z-index:101;
    ">开始标记</button>


    <button id="mark_end_button" style="
    width:50px;height:50px;
    position:absolute;
    left:200px;
    top:100px;
    z-index:101;
    ">结束标记</button>



    <button id="clear_draw_mark" style="
    width:50px;height:50px;
    position:absolute;
    left:250px;
    top:100px;
    z-index:101;
    ">清空标记</button>


    <button id="switch_skybox1" style="width:50px;height:50px;
    position:absolute;
    left:0px;
    top:150px;
    z-index:101;
    ">skybox1</button>


    <button id="switch_skybox2" style="width:50px;height:50px;
    position:absolute;
    left:50px;
    top:150px;
    z-index:101;
    ">skybox2</button>





    <script>
        // var isDrawLine = false;

        // var needRestoreDrawForLineAlpha = false;

        // var SOLID = 0;
        // var DASH = 1;

        // var lineType = SOLID;

        // var lineAlpha = 1;


        // var totalDrawPointArr = [];

        // var oneDragDrawPointArr = [];




        // var markData = {
        //     isBeginMark: false,
        //     totalMarkPosInWorld: []
        // };


        var currentSkybox = 0;



        var SOLID = 0;
        var DASH = 1;

        function _createLineData() {
            return {
                isDrawLine: false,

                needRestoreDrawForLineAlpha: false,

                lineType: SOLID,

                lineAlpha: 1,


                totalDrawPointArr: [],

                oneDragDrawPointArr: [],
            }
        }

        function _createMarkData() {
            return {
                isBeginMark: false,
                totalMarkPosInWorld: []
            }
        }




        var skybox1Data = {
            lineData: _createLineData(),
            markData: _createMarkData()
        };


        var skybox2Data = {
            lineData: _createLineData(),
            markData: _createMarkData()
        };



        function _getCurrentSkyboxData() {
            switch (currentSkybox) {
                case 0:
                    return skybox1Data;
                case 1:
                    return skybox2Data;
            }
        }

        function _setCurrentSkyboxIndex(index) {
            currentSkybox = index;
        };


        window.onload = function () {
            return AssetTool.loadConfig(["./config/setting.json", "./config/"], null, function () {
                try {
                    // initSample(wd.unsafeGetState())

                    var nx = new Image();
                    nx.src = "./res/skybox1/nx.jpg";
                    nx.onload = () => {

                        var px = new Image();
                        px.src = "./res/skybox1/px.jpg";
                        px.onload = () => {



                            var ny = new Image();
                            ny.src = "./res/skybox1/ny.jpg";
                            ny.onload = () => {



                                var py = new Image();
                                py.src = "./res/skybox1/py.jpg";
                                py.onload = () => {


                                    var nz = new Image();
                                    nz.src = "./res/skybox1/nz.jpg";
                                    nz.onload = () => {

                                        var pz = new Image();
                                        pz.src = "./res/skybox1/pz.jpg";
                                        pz.onload = () => {
                                            var nx2 = new Image();
                                            nx2.src = "./res/skybox2/nx.jpg";
                                            nx2.onload = () => {

                                                var px2 = new Image();
                                                px2.src = "./res/skybox2/px.jpg";
                                                px2.onload = () => {



                                                    var ny2 = new Image();
                                                    ny2.src = "./res/skybox2/ny.jpg";
                                                    ny2.onload = () => {



                                                        var py2 = new Image();
                                                        py2.src = "./res/skybox2/py.jpg";
                                                        py2.onload = () => {


                                                            var nz2 = new Image();
                                                            nz2.src = "./res/skybox2/nz.jpg";
                                                            nz2.onload = () => {

                                                                var pz2 = new Image();
                                                                pz2.src = "./res/skybox2/pz.jpg";
                                                                pz2.onload = () => {

                                                                    return initSample(
                                                                        [
                                                                            px, nx, py, ny, pz, nz
                                                                        ],
                                                                        [
                                                                            px2, nx2, py2, ny2, pz2, nz2
                                                                        ],
                                                                        wd.unsafeGetState());


                                                                };

                                                            };



                                                        };




                                                    };


                                                };


                                            };









                                        };

                                    };



                                };




                            };


                        };


                    };




                }
                catch (e) {
                    console.log("error: ", e)
                }
            });




            function _preventDefault(customEvent) {
                var event = wd.getPointEventEventOfEvent(wd.getCustomEventUserData(customEvent));

                if (event.cancelable) {
                    if (!event.defaultPrevented) {
                        event.preventDefault();
                    }
                }
            }


            function _getInterctedPoint(event, cameraGameObject, state, box2) {
                var ray = wd.createPerspectiveCameraRayFromEvent(
                    event,
                    cameraGameObject, state
                );

                var checkResult =
                    wd.checkIntersectMesh(
                        ray,
                        wd.unsafeGetGameObjectGeometryComponent(
                            box2, state,

                        ),
                        wd.getTransformLocalToWorldMatrixTypeArray(
                            wd.unsafeGetGameObjectTransformComponent(
                                box2, state
                            ), state
                        ),
                        1,
                        state
                    );

                var point =
                    wd.getIntersectedPointWithMesh(
                        checkResult
                    );

                // console.log(point);

                return point;

            };

            function _getScreenSize() {
                return [window.innerWidth, window.innerHeight];
            };


            function _isPointInScreenValid(pointInScreen) {
                return pointInScreen !== undefined;
            }

            function _isPointInScreenDataValid([pointInScreen, _lineType, _lineAlpha]) {
                return _isPointInScreenValid(pointInScreen);
            }


            function _isPointNear([x1, y1], [x2, y2], range) {
                return (x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2) < range;
            }


            function _remove(lastPointInScreen, newPointInScreenDataArr, range, remainPointInScreenDataArr) {
                var [lastPointInScreen, newPointInScreenDataArr] =
                    remainPointInScreenDataArr.reduce(([lastPointInScreen, newPointInScreenDataArr],
                        [pointInScreen, lineType, lineAlpha]
                    ) => {
                        if (_isPointNear(lastPointInScreen, pointInScreen, range)) {
                            return [lastPointInScreen, newPointInScreenDataArr]
                        }

                        newPointInScreenDataArr.push(
                            [pointInScreen, lineType, lineAlpha]
                        );

                        return [
                            pointInScreen,
                            newPointInScreenDataArr
                        ]
                    }, [lastPointInScreen, newPointInScreenDataArr]);

                return newPointInScreenDataArr;
            };


            function _removeNearPoints(pointInScreenDataArr) {
                if (pointInScreenDataArr.length <= 2) {
                    return pointInScreenDataArr;
                }

                return _remove(pointInScreenDataArr[2][0], [pointInScreenDataArr[0], pointInScreenDataArr[1]], 40, pointInScreenDataArr.slice(2));
            };


            function _bindArcballCameraControllerEvent(cameraController, state) {
                return wd.isBindArcballCameraControllerEvent(
                    cameraController, state
                ) ?
                    state
                    : wd.bindArcballCameraControllerEvent(
                        cameraController, state
                    );
            }



            function _drawLine(uiContext, totalDrawPointArr, cameraGameObject, state) {
                uiContext.lineWidth = 1;

                var pointInScreenDataArrArr =
                    totalDrawPointArr.map((oneDragDrawPointArr) => {
                        return oneDragDrawPointArr.map(([pointInWorld, lineType, lineAlpha]) => {
                            var [screenWidth, screenHeight] = _getScreenSize();

                            return [
                                wd.convertWorldToScreen(
                                    wd.unsafeGetGameObjectBasicCameraViewComponent(
                                        cameraGameObject, state
                                    ),
                                    wd.unsafeGetGameObjectPerspectiveCameraProjectionComponent(
                                        cameraGameObject, state
                                    ),
                                    [
                                        pointInWorld[0],
                                        pointInWorld[1],
                                        pointInWorld[2],
                                        screenWidth, screenHeight
                                    ],
                                    state
                                ),
                                lineType,
                                lineAlpha
                            ];
                        }).filter(_isPointInScreenDataValid)
                    }).filter((pointInScreenDataArr) => {
                        return pointInScreenDataArr.length > 0;
                    }).map(_removeNearPoints);


                pointInScreenDataArrArr.forEach((pointInScreenDataArr) => {
                    uiContext.beginPath();

                    var firstPointInScreenData = pointInScreenDataArr[0];

                    var _ =
                        pointInScreenDataArr.slice(1).reduce((lastPointInScreen,
                            [pointInScreen, lineType, lineAlpha]
                        ) => {

                            uiContext.strokeStyle = "rgba(255,0,255," + String(lineAlpha) + ")";


                            if (lineType === DASH) {
                                uiContext.setLineDash([5, 20]);
                            }
                            else {
                                uiContext.setLineDash([]);
                            }

                            uiContext.moveTo(lastPointInScreen[0], lastPointInScreen[1]);

                            uiContext.lineTo(pointInScreen[0], pointInScreen[1]);

                            return pointInScreen;
                        }, firstPointInScreenData[0]);


                    uiContext.stroke();
                })
            }

            function _drawMark(uiContext, markData, cameraGameObject, state) {
                markData.totalMarkPosInWorld.forEach(([markPosInWorld, text]) => {
                    var [screenWidth, screenHeight] = _getScreenSize();

                    var pointInScreen =
                        wd.convertWorldToScreen(
                            wd.unsafeGetGameObjectBasicCameraViewComponent(
                                cameraGameObject, state
                            ),
                            wd.unsafeGetGameObjectPerspectiveCameraProjectionComponent(
                                cameraGameObject, state
                            ),
                            [
                                markPosInWorld[0],
                                markPosInWorld[1],
                                markPosInWorld[2],
                                screenWidth, screenHeight
                            ],
                            state
                        );

                    if (!_isPointInScreenValid(pointInScreen)) {
                        return;
                    }



                    uiContext.textAlign = "center";
                    uiContext.textBaseline = "middle";

                    uiContext.fillStyle = "blue";

                    uiContext.fillText(text, pointInScreen[0], pointInScreen[1]);
                });


                return markData;
            }


            function _isTargetDom(event, domId) {
                return event.target.id === domId
            }


            function initSample(
                [
                    px, nx, py, ny, pz, nz
                ],
                [
                    px2, nx2, py2, ny2, pz2, nz2
                ],
                state
            ) {
                console.log("begin");


                var state = _switchSkybox1([
                    px, nx, py, ny, pz, nz
                ], state);


                var uiCanvas = document.querySelector("#ui-canvas");

                uiCanvas.width = window.innerWidth;
                uiCanvas.height = window.innerHeight;

                uiCanvas.style.width = "100%";
                uiCanvas.style.height = "100%";


                var uiContext = uiCanvas.getContext("2d");









                var [state, box1] = LightBoxesTool.createBox(state);



                var transform = wd.unsafeGetGameObjectTransformComponent(box1, state);

                var state = wd.setTransformLocalPosition(transform, [0, 0, -30], state);



                var [state, box2] = BasicBoxesTool.createBox(state);




                var transform = wd.unsafeGetGameObjectTransformComponent(box2, state);

                var state = wd.setTransformLocalPosition(transform, [0, 0, 0], state);







                var [state, box3] = LightBoxesTool.createBox(state);



                var transform = wd.unsafeGetGameObjectTransformComponent(box3, state);

                var state = wd.setTransformLocalScale(transform, [0.2, 0.2, 0.2], state);














                var state = wd.setAmbientLightColor([0.2, 0.2, 0.2], state);


                var [state, directionLightGameObject] = LightTool.createDirectionLight(state);

                var transform = wd.unsafeGetGameObjectTransformComponent(directionLightGameObject, state);

                var state = wd.setTransformLocalEulerAngles(transform, [0, 180, 0], state);




                var [state, cameraGameObject] = LightBoxesTool.createCamera(state);



                var [state, cameraController] = wd.createArcballCameraController(state);

                var state =
                    wd.setArcballCameraControllerMinDistance(cameraController, 0.001, state);
                var state =
                    wd.setArcballCameraControllerDistance(cameraController, 0.001, state);



                var state =
                    wd.setArcballCameraControllerWheelSpeed(cameraController, 1, state);

                var state = wd.addGameObjectArcballCameraControllerComponent(cameraGameObject, cameraController, state);


                // var state =
                //     wd.bindArcballCameraControllerEvent(
                //         cameraController, state
                //     );










                document.querySelector("#begin_draw_line").addEventListener("touchstart", function () {
                    var lineData = _getCurrentSkyboxData().lineData;

                    var state = wd.unsafeGetState();

                    var state =
                        wd.unbindArcballCameraControllerEvent(
                            cameraController, state
                        );

                    wd.setState(state);

                    lineData.isDrawLine = true;

                }, true);



                // document.querySelector("#begin_draw_line").addEventListener("touchend", function () {
                //     var state = wd.unsafeGetState();

                //     var state =
                //         wd.unbindArcballCameraControllerEvent(
                //             cameraController, state
                //         );

                //     wd.setState(state);


                //     isDrawLine = true;

                // }, true);










                document.querySelector("#end_draw_line").addEventListener("touchend", function () {
                    var lineData = _getCurrentSkyboxData().lineData;

                    wd.setState(_bindArcballCameraControllerEvent(cameraController, wd.unsafeGetState()));

                    lineData.isDrawLine = false;
                }, true)






                document.querySelector("#clear_draw_line").addEventListener("touchend", function () {
                    var lineData = _getCurrentSkyboxData().lineData;

                    lineData.oneDragDrawPointArr = [];
                    lineData.totalDrawPointArr = [];
                }, true)





                // document.querySelector("#line_type").addEventListener("touchstart", function () {
                //     if(isDrawLine){
                //         return
                //     };

                //     var state = wd.unsafeGetState();

                //     var state =
                //         wd.unbindArcballCameraControllerEvent(
                //             cameraController, state
                //         );

                //     wd.setState(state);
                // }, true);



                // document.querySelector("#line_type").addEventListener("change", function () {
                //     if (isDrawLine) {
                //         return
                //     };

                //     _bindArcballCameraControllerEvent(cameraController, state)
                // }, true);


                // document.querySelector("#line_type").addEventListener("blur", function () {
                //     if (isDrawLine) {
                //         return
                //     };

                //     _bindArcballCameraControllerEvent(cameraController, state)
                // }, true);



                // document.querySelector("#line_alpha").addEventListener("focus", function () {
                //     console.log("focus")
                //     var state = wd.unsafeGetState();

                //     var state =
                //         wd.unbindArcballCameraControllerEvent(
                //             cameraController, state
                //         );

                //     wd.setState(state);
                // }, true);



                // document.querySelector("#line_alpha").addEventListener("touchstart", function () {
                //     console.log("touchstart")



                //     var state = wd.unsafeGetState();

                //     var state =
                //         wd.unbindArcballCameraControllerEvent(
                //             cameraController, state
                //         );

                //     wd.setState(state);


                //     // var lineData = _getCurrentSkyboxData().lineData;

                //     // var {
                //     //     isDrawLine
                //     // } = lineData;


                //     // if (isDrawLine) {
                //     //     lineData.isDrawLine = false;

                //     //     lineData.needRestoreDrawForLineAlpha = true;

                //     //     return;
                //     // }

                //     // lineData.needRestoreDrawForLineAlpha = false;
                // }, true);

                // document.querySelector("#line_alpha").addEventListener("touchend", function () {
                //     console.log("touchend")

                //     wd.setState(_bindArcballCameraControllerEvent(cameraController, wd.unsafeGetState()));

                //     // var lineData = _getCurrentSkyboxData().lineData;

                //     // var {
                //     //     needRestoreDrawForLineAlpha
                //     // } = lineData;

                //     // if (needRestoreDrawForLineAlpha) {
                //     //     lineData.isDrawLine = true;

                //     //     lineData.needRestoreDrawForLineAlpha = false;

                //     //     return;
                //     // }

                // }, true);






                document.querySelector("#mark_text").addEventListener("focus", function () {
                    wd.setState(wd.unbindArcballCameraControllerEvent(cameraController, wd.unsafeGetState()));
                }, true);


                document.querySelector("#mark_text").addEventListener("blur", function () {
                    wd.setState(_bindArcballCameraControllerEvent(cameraController, wd.unsafeGetState()));
                }, true);



                document.querySelector("#mark_begin_button").addEventListener("touchend", function () {
                    var markData = _getCurrentSkyboxData().markData;

                    markData.isBeginMark = true;

                    var state = wd.unsafeGetState();

                    var state =
                        wd.unbindArcballCameraControllerEvent(
                            cameraController, state
                        );

                    wd.setState(state);
                }, true)



                document.querySelector("#mark_end_button").addEventListener("touchend", function () {
                    var markData = _getCurrentSkyboxData().markData;

                    markData.isBeginMark = false;

                    var state = wd.unsafeGetState();

                    var state =
                        _bindArcballCameraControllerEvent(
                            cameraController, state
                        );

                    wd.setState(state);
                }, true)



                document.querySelector("#clear_draw_mark").addEventListener("touchend", function () {
                    _getCurrentSkyboxData().markData = {
                        isBeginMark: false,
                        totalMarkPosInWorld: []
                    }
                }, true)

                function _switchSkybox1(skyboxImageArr, state) {
                    _setCurrentSkyboxIndex(0);

                    var state = wd.setSkyboxImage(
                        skyboxImageArr, state
                    );

                    var state = wd.setSkyboxNeedUpdateCubeTexture(true, state);

                    return state;
                }

                function _switchSkybox2(skyboxImageArr, state) {
                    _setCurrentSkyboxIndex(1);

                    var state = wd.setSkyboxImage(
                        skyboxImageArr, state
                    );

                    var state = wd.setSkyboxNeedUpdateCubeTexture(true, state);

                    return state;
                }

                document.querySelector("#switch_skybox1").addEventListener("touchstart", function () {
                    var state = wd.unsafeGetState();

                    var state = _switchSkybox1([
                        px, nx, py, ny, pz, nz
                    ],
                        state);

                    wd.setState(state);
                }, true);

                document.querySelector("#switch_skybox2").addEventListener("touchstart", function () {
                    var state = wd.unsafeGetState();

                    var state = _switchSkybox2([
                        px2, nx2, py2, ny2, pz2, nz2
                    ],
                        state);

                    wd.setState(state);
                }, true);




                var state =
                    wd.onCustomGlobalEvent(
                        wd.getPointDownEventName(),
                        0,
                        (event, state) => {
                            var markData = _getCurrentSkyboxData().markData;

                            var {
                                isBeginMark
                            } = markData;


                            if (
                                !isBeginMark
                                || _isTargetDom(
                                    wd.getPointEventEventOfEvent(
                                        wd.getCustomEventUserData(event)
                                    ),
                                    "mark_end_button"
                                )
                            ) {
                                return [state, event];
                            }

                            markData.totalMarkPosInWorld.push([
                                _getInterctedPoint(event, cameraGameObject, state, box2),
                                document.querySelector("#mark_text").value
                            ]);

                            return [state, event];

                        }, state
                    );



                var state =
                    wd.onCustomGlobalEvent(
                        wd.getPointDragStartEventName(),
                        0,
                        (event, state) => {
                            // _preventDefault(event);
                            var lineData = _getCurrentSkyboxData().lineData;

                            var {
                                isDrawLine,
                            } = lineData;

                            if (!isDrawLine) {
                                return [state, event];
                            }

                            var lineTypeSelectDom = document.querySelector("#line_type");
                            switch (lineTypeSelectDom.options[lineTypeSelectDom.selectedIndex].value) {
                                case "solid":
                                    lineData.lineType = SOLID;
                                    break;

                                case "dash":
                                    lineData.lineType = DASH;
                                    break
                            };

                            lineData.lineAlpha = Number(document.querySelector("#line_alpha").value);


                            lineData.oneDragDrawPointArr = [];
                            lineData.totalDrawPointArr.push(
                                lineData.oneDragDrawPointArr
                            );

                            return [state, event];

                        }, state
                    );


                var state =
                    wd.onCustomGlobalEvent(
                        wd.getPointDragOverEventName(),
                        0,
                        (event, state) => {
                            // _preventDefault(event);
                            var lineData = _getCurrentSkyboxData().lineData;

                            var {
                                isDrawLine,
                                lineType,
                                lineAlpha,
                            } = lineData;

                            if (!isDrawLine) {
                                return [state, event];
                            }



                            lineData.oneDragDrawPointArr.push(
                                [
                                    _getInterctedPoint(event, cameraGameObject, state, box2),
                                    lineType,
                                    lineAlpha,
                                ]
                            );

                            return [state, event];

                        }, state
                    );


                var state = wd.registerNoWorkerLoopJob("update_ui", (_, state) => {
                    var lineData = _getCurrentSkyboxData().lineData;

                    var {
                        totalDrawPointArr
                    } = lineData;

                    uiContext.clearRect(0, 0, uiCanvas.width, uiCanvas.height);

                    _drawLine(uiContext, totalDrawPointArr, cameraGameObject, state);


                    var markData = _getCurrentSkyboxData().markData;

                    _getCurrentSkyboxData().markData = _drawMark(
                        uiContext,
                        markData, cameraGameObject, state
                    );

                    return state;
                }, state);








                // wd.startDirector(state);


                console.log("end");
            }
        };
    </script>
</body>

</html>